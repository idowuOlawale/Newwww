<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Octra Testnet Explorer</title>
  <script src="https://cdn.jsdelivr.net/npm/viem@2/viem.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lucide@0.454.0/dist/umd/lucide.min.js"></script>
  <style>
    :root { --bg:#0a0e1a; --card:#141a2e; --accent:#00f5ff; --text:#c0eaff; }
    body { margin:0; font-family:system-ui; background:var(--bg); color:var(--text); padding:20px; }
    .container { max-width:1100px; margin:auto; }
    h1 { text-align:center; color:var(--accent); }
    .search-box { display:flex; gap:12px; margin:30px 0; }
    input { flex:1; padding:18px; font-size:1.2rem; border-radius:16px; border:none; background:var(--card); color:white; }
    button { padding:0 32px; font-size:1.2rem; background:var(--accent); color:#000; border:none; border-radius:16px; cursor:pointer; font-weight:bold; }
    button:hover { background:#00ffff; }
    .card { background:var(--card); border-radius:16px; padding:24px; margin-bottom:24px; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:14px; text-align:left; border-bottom:1px solid #333; }
    th { background:rgba(0,245,255,0.1); }
    .loading { text-align:center; padding:60px; font-size:1.3rem; color:var(--accent); }
    a { color:var(--accent); }
    .stats { display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:16px; margin:20px 0; }
    .stat { background:rgba(0,245,255,0.05); padding:16px; border-radius:12px; text-align:center; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Octra Testnet Explorer</h1>
    <p style="text-align:center;opacity:0.8">Chain ID 42069 • Real RPC • Button Fixed</p>

    <div class="card">
      <div class="stats">
        <div class="stat"><strong>Epoch</strong><br>198,299</div>
        <div class="stat"><strong>Total Txs</strong><br>171.38M</div>
        <div class="stat"><strong>Accounts</strong><br>1.44M</div>
        <div class="stat"><strong>Validators</strong><br>37</div>
      </div>
    </div>

    <div class="search-box">
      <input type="text" id="addr" placeholder="Enter Octra testnet address (0x...)" autofocus>
      <button id="search">Search</button>
    </div>

    <div id="loading" class="loading" style="display:none;">Fetching data from Octra Testnet RPC...</div>

    <div id="result" style="display:none;">
      <div class="card"><h2>Native Balance</h2><h1 id="bal">-</h1></div>
      <div class="card"><h2>Token Balances</h2><div id="tokens">—</div></div>
      <div class="card"><h2>Recent Transactions</h2>
        <table><thead><tr><th>Hash</th><th>Type</th><th>Amount</th><th>Block</th></tr></thead><tbody id="txs"></tbody></table>
      </div>
    </div>
  </div>

<script>
  lucide.createIcons();

  const client = viem.createPublicClient({
    chain: { id: 42069n, name: "Octra Testnet", nativeCurrency: { name: "OCT", symbol: "OCT", decimals: 18 },
      rpcUrls: { default: { http: ["https://octra-testnet-rpc.caldera.xyz/rpc"] } }
    },
    transport: viem.http()
  });

  const TOKENS = [
    "0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48", // USDC
    "0xdAC17F958D2ee523a2206206994597C13D831ec7"  // USDT
  ];

  async function go() {
    const address = document.getElementById("addr").value.trim();
    if (!viem.isAddress(address)) return alert("Invalid address");

    document.getElementById("loading").style.display = "block";
    document.getElementById("result").style.display = "none";

    try {
      // Balance
      const balance = await client.getBalance({ address });
      document.getElementById("bal").textContent = Number(viem.formatEther(balance)).toFixed(6) + " OCT";

      // Tokens
      let tokenHTML = "";
      for (const token of TOKENS) {
        try {
          const bal = await client.readContract({
            address: token,
            abi: [{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}],
            functionName: "balanceOf",
            args: [address]
          });
          if (bal > 0) {
            const symbol = await client.readContract({ address: token, abi: [{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"}], functionName: "symbol" });
            tokenHTML += `<div>${symbol}: ${(Number(bal)/1e6).toFixed(2)}</div>`;
          }
        } catch {}
      }
      document.getElementById("tokens").innerHTML = tokenHTML || "No tokens found";

      // Recent txs (last 40 blocks)
      const latest = await client.getBlockNumber();
      const found = [];
      for (let i = 0; i < 40 && found.length < 20; i++) {
        const block = await client.getBlock({ blockNumber: latest - BigInt(i), includeTransactions: true });
        for (const tx of block.transactions) {
          if (tx.from?.toLowerCase() === address.toLowerCase() || tx.to?.toLowerCase() === address.toLowerCase()) {
            found.push(tx);
          }
        }
      }

      const tbody = document.getElementById("txs");
      tbody.innerHTML = found.map(tx => {
        const sent = tx.from.toLowerCase() === address.toLowerCase();
        return `<tr>
          <td><a href="https://octrascan.io/tx/${tx.hash}" target="_blank">${tx.hash.slice(0,16)}...</a></td>
          <td>${sent ? "Sent" : "Received"}</td>
          <td>${viem.formatEther(tx.value || 0n)}</td>
          <td>Block ${tx.blockNumber}</td>
        </tr>`;
      }).join("") || "<tr><td colspan='4'>No recent transactions</td></tr>";

      document.getElementById("loading").style.display = "none";
      document.getElementById("result").style.display = "block";
    } catch (e) {
      document.getElementById("loading").innerHTML = "Error: " + e.message;
    }
  }

  // Button works + Enter key works
  document.getElementById("search").addEventListener("click", go);
  document.getElementById("addr").addEventListener("keypress", e => e.key === "Enter" && go());
</script>
</body>
</html>