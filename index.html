<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Permit2 USDC Drip – 0.00001 every minute</title>
<script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
<script src="https://unpkg.com/@uniswap/permit2-sdk@1.2.0/dist/permit2-sdk.umd.js"></script>
<style>
  body{background:#0f0f23;color:#e0e0e0;font-family:system-ui;display:flex;min-height:100vh;align-items:center;justify-content:center;margin:0;}
  .card{background:#1e293b;max-width:560px;width:100%;padding:40px;border-radius:20px;box-shadow:0 20px 60px #0008;text-align:center;}
  h1{color:#60a5fa;margin-bottom:10px;}
  p{font-size:17px;line-height:1.5;}
  button{background:#10b981;color:white;border:none;padding:16px 32px;font-size:18px;border-radius:12px;cursor:pointer;font-weight:bold;margin:10px;}
  .addr{background:#334155;padding:12px;border-radius:10px;margin:20px 0;word-break:break-all;font-family:monospace;}
  .status{margin:20px 0;padding:15px;background:#334155;border-radius:10px;font-size:16px;}
  .log{margin:20px 0;padding:15px;background:#1e293b;border-radius:10px;max-height:300px;overflow-y:auto;text-align:left;font-family:monospace;font-size:14px;}
</style>
</head>
<body>
<div class="card">
  <h1>Permit2 USDC Drip</h1>
  <p>Send <strong>0.00001 USDC every 60 seconds</strong> to:</p>
  <div class="addr">0xcde71a94923dd426910ce9beb8e1d1c3eb11cd2f</div>

  <button id="connectBtn">Connect Wallet (Base)</button>
  <button id="signBtn" style="display:none;">Sign Once (Gas-Free)</button>
  <button id="startBtn" style="display:none;">Start Drip</button>
  <button id="stopBtn" style="display:none;background:#ef4444;">Stop Drip</button>

  <div class="status" id="status">Not connected</div>
  <div class="log" id="log" style="display:none;"></div>
</div>

<script>
const TARGET = "0xcde71a94923dd426910ce9beb8e1d1c3eb11cd2f";
const USDC = "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913";
const PERMIT2 = "0x000000000022D473030F116dDEE9F6B43aC78BA3"; // Permit2 on all chains including Base
const AMOUNT = 10000n; // 0.00001 USDC (6 decimals)
const INTERVAL = 60000; // 60 seconds

let web3, account, permitSignature, intervalId;
const status = document.getElementById('status');
const log = document.getElementById('log');

function addLog(txt) {
  log.innerHTML += `<div>${new Date().toLocaleTimeString()} – ${txt}</div>`;
  log.scrollTop = log.scrollHeight;
  log.style.display = 'block';
}

document.getElementById('connectBtn').onclick = async () => {
  if (!window.ethereum) return alert("Install MetaMask");
  web3 = new Web3(window.ethereum);
  await ethereum.request({method:'eth_requestAccounts'});
  const chainId = await web3.eth.getChainId();
  if (chainId !== 8453) {
    await ethereum.request({method:"wallet_switchEthereumChain", params:[{chainId:"0x2105"}]});
  }
  [account] = await web3.eth.getAccounts();
  status.textContent = `Connected: ${account.slice(0,10)}...`;
  document.getElementById('connectBtn').style.display = 'none';
  document.getElementById('signBtn').style.display = 'block';
  addLog("Wallet connected on Base");
};

document.getElementById('signBtn').onclick = async () => {
  const nonce = await web3.eth.getTransactionCount(account);
  const deadline = Math.floor(Date.now() / 1000) + 60 * 60 * 24 * 365; // 1 year

  const permitSingle = {
    details: {
      token: USDC,
      amount: "115792089237316195423570985008687907853269984665640564039457584007913129639935", // max
      expiration: deadline,
      nonce: nonce
    },
    spender: account, // we spend from ourselves
    sigDeadline: deadline
  };

  const { domain, types, values } = Permit2.PermitSingle.buildPermitSingle(permitSingle, PERMIT2, 8453, account);

  const signature = await ethereum.request({
    method: "eth_signTypedData_v4",
    params: [account, JSON.stringify({ domain, types, message: values })]
  });

  permitSignature = signature;
  localStorage.setItem("permitSig", signature);
  document.getElementById('signBtn').style.display = 'none';
  document.getElementById('startBtn').style.display = 'block';
  addLog("One-time Permit2 signature saved (gas-free)");
};

document.getElementById('startBtn').onclick = async () => {
  if (!permitSignature) permitSignature = localStorage.getItem("permitSig");
  if (!permitSignature) return alert("Sign first");

  document.getElementById('startBtn').style.display = 'none';
  document.getElementById('stopBtn').style.display = 'block';
  status.textContent = "Dripping 0.00001 USDC every minute...";

  intervalId = setInterval(async () => {
    try {
      const permitTransferFrom = {
        permitted: { token: USDC, amount: AMOUNT },
        spender: TARGET,
        nonce: 0,
        deadline: Math.floor(Date.now() / 1000) + 300
      };

      const { domain, types, values } = Permit2.PermitTransferFrom.buildPermitTransferFrom(permitTransferFrom, PERMIT2, 8453, account);

      const tx = await web3.eth.sendTransaction({
        from: account,
        to: PERMIT2,
        data: Permit2.SignatureTransfer.encodePermitTransferFromAndTransferFrom(
          { permitted: permitTransferFrom.permitted, nonce: permitTransferFrom.nonce, deadline: permitTransferFrom.deadline },
          { to: TARGET, requestedAmount: AMOUNT },
          account,
          permitSignature
        ),
        gas: 200000
      });

      addLog(`Sent 0.00001 USDC → ${tx.transactionHash.slice(0,12)}...`);
    } catch (e) {
      addLog("Error: " + e.message.split("\n")[0]);
    }
  }, INTERVAL);

  addLog("Drip started");
};

document.getElementById('stopBtn').onclick = () => {
  clearInterval(intervalId);
  document.getElementById('stopBtn').style.display = 'none';
  document.getElementById('startBtn').style.display = 'block';
  status.textContent = "Drip stopped";
  addLog("Drip stopped");
};
</script>
</body>
</html>