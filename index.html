<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sui Wallet Dashboard - Campus Hackathon</title>
  <script type="module">
    import { getWallets } from "https://cdn.jsdelivr.net/npm/@mysten/wallet-standard@latest/+esm";
    import { SuiClient, getFullnodeUrl } from "https://cdn.jsdelivr.net/npm/@mysten/sui@latest/client/+esm";
    import { Transaction } from "https://cdn.jsdelivr.net/npm/@mysten/sui@latest/transactions/+esm";

    const NETWORK = 'testnet'; // Switch to 'mainnet' later if needed
    const client = new SuiClient({ url: getFullnodeUrl(NETWORK) });

    const wallets = getWallets();

    let currentAccount = null;
    let currentWallet = null;

    // DOM
    const connectBtn = document.getElementById('connectBtn');
    const addressEl = document.getElementById('address');
    const balanceEl = document.getElementById('balance');
    const statusEl = document.getElementById('status');
    const modal = document.getElementById('walletModal');
    const walletList = document.getElementById('walletList');
    const closeModal = document.getElementsByClassName('close')[0];
    const txSection = document.getElementById('txSection');
    const txList = document.getElementById('txList');
    const transferSection = document.getElementById('transferSection');
    const recipientInput = document.getElementById('recipient');
    const amountInput = document.getElementById('amount');
    const sendBtn = document.getElementById('sendBtn');
    const txResult = document.getElementById('txResult');

    async function updateUI() {
      if (currentAccount) {
        addressEl.textContent = currentAccount.address.slice(0, 6) + '...' + currentAccount.address.slice(-4);
        connectBtn.textContent = 'Disconnect';
        statusEl.textContent = `Connected via ${currentWallet.name}`;
        transferSection.style.display = 'block';
        txSection.style.display = 'block';

        // Balance
        try {
          const { totalBalance } = await client.getBalance({ owner: currentAccount.address });
          balanceEl.textContent = `${(BigInt(totalBalance) / BigInt(1_000_000_000)).toFixed(4)} SUI`;
        } catch { balanceEl.textContent = 'Error'; }

        // Transactions
        await loadTransactions();
      } else {
        addressEl.textContent = '-';
        balanceEl.textContent = '-';
        connectBtn.textContent = 'Connect Wallet';
        statusEl.textContent = '';
        transferSection.style.display = 'none';
        txSection.style.display = 'none';
        txList.innerHTML = '';
        txResult.innerHTML = '';
      }
    }

    async function loadTransactions() {
      txList.innerHTML = '<li>Loading...</li>';
      try {
        const txns = await client.queryTransactionBlocks({
          filter: { Or: [{ FromAddress: currentAccount.address }, { ToAddress: currentAccount.address }] },
          order: 'descending',
          limit: 15,
          options: { showEffects: true, showBalanceChanges: true }
        });
        txList.innerHTML = txns.data.length === 0 ? '<li>No transactions yet.</li>' : '';
        txns.data.forEach(txn => {
          const li = document.createElement('li');
          const link = `https://suiscan.xyz/${NETWORK}/tx/${txn.digest}`;
          const status = txn.effects?.status?.status || 'Unknown';
          let desc = 'Other', amount = '';
          const suiChange = txn.balanceChanges?.find(c => c.coinType.endsWith('::sui::SUI'));
          if (suiChange) {
            const change = (BigInt(suiChange.amount) / BigInt(1_000_000_000)).toString();
            desc = change > 0 ? 'Received' : 'Sent';
            amount = change > 0 ? `+${change}` : change;
          }
          li.innerHTML = `<strong><a href="${link}" target="_blank">${txn.digest.slice(0,10)}...</a></strong><br>${desc} ${amount} SUI • ${status}`;
          txList.appendChild(li);
        });
      } catch { txList.innerHTML = '<li>Error loading.</li>'; }
    }

    async function sendSui() {
      const recipient = recipientInput.value.trim();
      const amountStr = amountInput.value.trim();
      if (!recipient || !amountStr) return txResult.innerHTML = '<span style="color:red">Fill both fields</span>';
      const amount = parseFloat(amountStr);
      if (amount <= 0) return txResult.innerHTML = '<span style="color:red">Invalid amount</span>';

      txResult.textContent = 'Preparing...';
      sendBtn.disabled = true;

      try {
        const txb = new Transaction();
        const [coin] = txb.splitCoins(txb.gas, [BigInt(amount * 1_000_000_000)]);
        txb.transferObjects([coin], recipient);
        txb.setSender(currentAccount.address);

        const result = await currentWallet.features['sui:signAndExecuteTransaction'].signAndExecuteTransaction({
          transaction: txb,
          chain: `sui:${NETWORK}`
        });

        if (result.effects?.status?.status === 'success') {
          const link = `https://suiscan.xyz/${NETWORK}/tx/${result.digest}`;
          txResult.innerHTML = `<span style="color:green">Sent! <a href="${link}" target="_blank">View</a></span>`;
          recipientInput.value = ''; amountInput.value = '';
          updateUI();
        } else {
          txResult.innerHTML = `<span style="color:red">Failed</span>`;
        }
      } catch (err) {
        txResult.innerHTML = `<span style="color:red">Rejected/Error: ${err.message}</span>`;
      } finally { sendBtn.disabled = false; }
    }

    // Wallet functions (connect, disconnect, modal) same as before...
    async function connectWallet(wallet) {
      try {
        const { accounts } = await wallet.features['standard:connect'].connect();
        if (accounts.length > 0) { currentAccount = accounts[0]; currentWallet = wallet; }
      } catch { statusEl.textContent = 'Failed'; }
      modal.style.display = 'none';
      updateUI();
    }

    async function disconnect() {
      if (currentWallet?.features['standard:disconnect']) await currentWallet.features['standard:disconnect'].disconnect();
      currentAccount = null; currentWallet = null;
      updateUI();
    }

    function showModal() {
      const available = wallets.get();
      walletList.innerHTML = available.length === 0 ? '<li>Install Slush wallet extension</li>' : '';
      available.forEach(w => {
        const li = document.createElement('li');
        const btn = document.createElement('button');
        btn.textContent = w.name + (w.accounts.length > 0 ? ' (Connected)' : '');
        btn.onclick = () => connectWallet(w);
        li.appendChild(btn);
        walletList.appendChild(li);
      });
      modal.style.display = 'block';
    }

    connectBtn.onclick = () => currentAccount ? disconnect() : showModal();
    closeModal.onclick = () => modal.style.display = 'none';
    window.onclick = e => { if (e.target === modal) modal.style.display = 'none'; };
    sendBtn.onclick = sendSui;

    wallets.on('change', () => { /* auto-restore logic */ updateUI(); });
    setTimeout(() => { wallets.get().forEach(w => { if (w.accounts.length > 0) { currentAccount = w.accounts[0]; currentWallet = w; } }); updateUI(); }, 1000);
  </script>

  <style>
    /* Same beautiful styles as previous version */
    body { font-family: Arial, sans-serif; text-align: center; padding: 30px; background: #f0f8ff; max-width: 800px; margin: auto; }
    h1 { color: #0066ff; }
    button { padding: 12px 24px; background: #0066ff; color: white; border: none; border-radius: 8px; cursor: pointer; }
    input { padding: 12px; width: 300px; margin: 10px; border-radius: 8px; border: 1px solid #ccc; }
    .section { margin: 40px 0; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    #txList { list-style: none; padding: 0; text-align: left; }
    #txList li { padding: 12px; margin: 8px 0; background: #f8f9fa; border-radius: 8px; }
    .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
    .modal-content { background: white; margin: 15% auto; padding: 20px; width: 80%; max-width: 500px; border-radius: 12px; }
  </style>
</head>
<body>
  <h1>Sui Wallet Dashboard</h1>
  <p>A simple yet powerful Sui dApp for managing your wallet – built for the Campus Hackathon!</p>

  <button id="connectBtn">Connect Wallet</button>

  <div class="section">
    <p><strong>Address:</strong> <span id="address">-</span></p>
    <p><strong>Balance (${NETWORK}):</strong> <span id="balance">-</span></p>
  </div>

  <p id="status"></p>

  <div id="transferSection" class="section" style="display:none;">
    <h2>Send SUI</h2>
    <input type="text" id="recipient" placeholder="Recipient address" /><br>
    <input type="number" id="amount" step="0.0001" placeholder="Amount (SUI)" /><br>
    <button id="sendBtn">Send</button>
    <div id="txResult"></div>
  </div>

  <div id="txSection" class="section" style="display:none;">
    <h2>Recent Transactions</h2>
    <ul id="txList"></ul>
  </div>

  <div id="walletModal" class="modal"><!-- modal content --></div>
</body>
</html>
