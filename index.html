<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus Pay - LASUSTECH</title>
    <style>
        body {
            font-family: 'Inter', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0f172a, #1e293b, #4c1d95);
            color: #e2e8f0;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-attachment: fixed;
        }
        header {
            text-align: center;
            padding: 40px 20px;
        }
        .logo {
            height: 80px;
            margin-bottom: 20px;
        }
        h1 {
            font-size: 3.5em;
            margin: 0;
            background: linear-gradient(to right, #60a5fa, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .subtitle {
            font-size: 1.4em;
            opacity: 0.9;
            max-width: 700px;
        }
        main {
            max-width: 600px;
            width: 90%;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 40px;
            margin: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .connect-section {
            text-align: center;
        }
        button {
            padding: 16px 32px;
            font-size: 1.2em;
            background: linear-gradient(to right, #3b82f6, #8b5cf6);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: 0.3s;
            box-shadow: 0 10px 20px rgba(59,130,246,0.3);
        }
        button:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(59,130,246,0.4);
        }
        input {
            width: 100%;
            padding: 16px;
            margin: 20px 0;
            border-radius: 16px;
            border: none;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1.1em;
        }
        input::placeholder { color: rgba(255,255,255,0.6); }
        .info {
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 16px;
            margin: 20px 0;
            font-size: 1.2em;
        }
        #walletModal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .modal-content {
            background: #1e293b;
            padding: 40px;
            border-radius: 24px;
            width: 90%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
        }
        .wallet-option {
            display: flex;
            align-items: center;
            gap: 20px;
            background: rgba(255,255,255,0.05);
            padding: 20px;
            margin: 15px 0;
            border-radius: 16px;
            cursor: pointer;
            transition: 0.3s;
        }
        .wallet-option:hover {
            background: rgba(255,255,255,0.1);
            transform: scale(1.03);
        }
        .wallet-option img {
            height: 50px;
            border-radius: 12px;
        }
        #status {
            margin-top: 30px;
            font-size: 1.2em;
            min-height: 30px;
        }
        .error { color: #f87171; }
        footer {
            margin-top: auto;
            padding: 30px;
            opacity: 0.7;
            font-size: 0.9em;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    </style>
</head>
<body>
    <header>
        <img class="logo" src="https://mms.businesswire.com/media/20231212525990/en/1839000/5/Sui_Logo_White.jpg" alt="Sui Logo">
        <h1>Campus Pay</h1>
        <p class="subtitle">Instant, Secure Payments on LASUSTECH Campus – Powered by Sui Blockchain</p>
    </header>

    <main>
        <div id="accountInfo" class="info" style="display:none;"></div>
        <div id="balance" class="info" style="display:none;"></div>

        <div id="connectSection" class="connect-section">
            <button id="connectButton">Connect Wallet</button>
        </div>

        <div id="paymentForm" style="display:none; margin-top:40px;">
            <label>Recipient Address</label>
            <input id="recipient" type="text" placeholder="0x...">

            <label>Amount (SUI)</label>
            <input id="amount" type="number" step="0.001" min="0.001" placeholder="e.g. 1.0">

            <button id="payButton">Send Payment</button>
        </div>

        <p id="status"></p>
    </main>

    <div id="walletModal">
        <div class="modal-content">
            <h2>Select Your Wallet</h2>
            <div id="walletList"></div>
            <p style="margin-top:30px;">Don't have one? Get <a href="https://slush.app" target="_blank" style="color:#60a5fa;">Slush</a> or <a href="https://okx.com/web3" target="_blank" style="color:#60a5fa;">OKX Wallet</a></p>
            <button onclick="document.getElementById('walletModal').style.display='none'">Close</button>
        </div>
    </div>

    <footer>Testnet Demo • SUI Hackathon Project • Use Slush or OKX Wallet</footer>

    <script type="module">
        import { getFullnodeUrl, SuiClient } from 'https://unpkg.com/@mysten/sui@latest/client?module';
        import { Transaction } from 'https://unpkg.com/@mysten/sui@latest/transactions?module';
        import { getWallets } from 'https://unpkg.com/@wallet-standard/app@latest?module';

        const registry = getWallets();
        let wallets = [];
        let currentWallet = null;
        let currentAccount = null;

        const client = new SuiClient({ url: getFullnodeUrl('testnet') });

        const updateWalletsAndConnect = () => {
            wallets = registry.get().filter(w => w.chains.some(c => c.startsWith('sui:')));
            checkForConnectedAccounts();
        };

        const checkForConnectedAccounts = () => {
            for (const wallet of wallets) {
                const suiAccounts = wallet.accounts.filter(a => a.chains.some(c => c.startsWith('sui:')));
                if (suiAccounts.length > 0) {
                    currentWallet = wallet;
                    currentAccount = suiAccounts[0];
                    showConnected();
                    loadBalance();
                    return true;
                }
            }
            return false;
        };

        registry.on('register', updateWalletsAndConnect);
        registry.on('unregister', updateWalletsAndConnect);
        updateWalletsAndConnect(); // Initial check

        function showConnected() {
            document.getElementById('accountInfo').innerText = `Connected: ${currentAccount.address.slice(0,6)}...${currentAccount.address.slice(-4)} (${currentWallet.name})`;
            document.getElementById('accountInfo').style.display = 'block';
            document.getElementById('connectSection').style.display = 'none';
            document.getElementById('paymentForm').style.display = 'block';
        }

        async function loadBalance() {
            try {
                const { totalBalance } = await client.getBalance({ owner: currentAccount.address });
                const sui = (BigInt(totalBalance) / 1000000000n).toString() + '.' + (BigInt(totalBalance) % 1000000000n).toString().padStart(9, '0').slice(0,3);
                document.getElementById('balance').innerText = `Balance: ${sui} SUI`;
                document.getElementById('balance').style.display = 'block';
            } catch (e) {
                document.getElementById('balance').innerText = 'Balance: Error';
                document.getElementById('balance').style.display = 'block';
            }
        }

        document.getElementById('connectButton').onclick = () => {
            const modal = document.getElementById('walletModal');
            const list = document.getElementById('walletList');
            list.innerHTML = '';
            if (wallets.length === 0) {
                list.innerHTML = '<p>No Sui wallets detected. Install Slush or OKX.</p>';
            } else {
                wallets.forEach(wallet => {
                    const div = document.createElement('div');
                    div.className = 'wallet-option';
                    div.onclick = async () => {
                        try {
                            await wallet.features['standard:connect'].connect();
                            updateWalletsAndConnect();
                            modal.style.display = 'none';
                            setStatus('Connected!');
                        } catch (err) {
                            setStatus('Connection rejected or failed.', true);
                        }
                    };
                    const img = document.createElement('img');
                    img.src = wallet.icon;
                    img.alt = wallet.name;
                    const span = document.createElement('span');
                    span.textContent = wallet.name;
                    div.appendChild(img);
                    div.appendChild(span);
                    list.appendChild(div);
                });
            }
            modal.style.display = 'flex';
        };

        function setStatus(msg, error = false) {
            const el = document.getElementById('status');
            el.innerText = msg;
            el.classList.toggle('error', error);
        }

        document.getElementById('payButton').onclick = async () => {
            const recipient = document.getElementById('recipient').value.trim();
            const amountStr = document.getElementById('amount').value;
            if (!recipient || !amountStr) return setStatus('Fill all fields', true);

            const amount = parseFloat(amountStr);
            if (isNaN(amount) || amount <= 0) return setStatus('Invalid amount', true);

            setStatus('Signing transaction...');

            try {
                const tx = new Transaction();
                const amountMist = BigInt(Math.floor(amount * 1_000_000_000));
                const [coin] = tx.splitCoins(tx.gas, [amountMist]);
                tx.transferObjects([coin], recipient);
                tx.setSender(currentAccount.address);

                const { transactionBlockBytes } = await tx.build({ client });

                const { signature } = await currentWallet.features['sui:signTransactionBlock'].signTransactionBlock({
                    transactionBlock: transactionBlockBytes,
                    account: currentAccount,
                    chain: 'sui:testnet'
                });

                const resp = await client.executeTransactionBlock({
                    transactionBlock: transactionBlockBytes,
                    signature,
                    options: { showEffects: true }
                });

                setStatus(`Success! Digest: ${resp.digest.substring(0,12)}...`);
                loadBalance();
            } catch (e) {
                setStatus(`Error: ${e.message || 'Failed'}`, true);
            }
        };
    </script>
</body>
</html>
