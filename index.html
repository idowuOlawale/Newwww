<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sui Wallet Dashboard - Enhanced</title>
  
  <script type="module">
    // --- SDK Imports from CDN ---
    import { getWallets } from "https://cdn.jsdelivr.net/npm/@mysten/wallet-standard@latest/+esm";
    import { SuiClient, getFullnodeUrl } from "https://cdn.jsdelivr.net/npm/@mysten/sui@latest/client/+esm";
    import { Transaction } from "https://cdn.jsdelivr.net/npm/@mysten/sui@latest/transactions/+esm";

    const NETWORK = 'testnet';
    const MIST_PER_SUI = BigInt(1_000_000_000);
    const client = new SuiClient({ url: getFullnodeUrl(NETWORK) });

    const wallets = getWallets();

    let currentAccount = null;
    let currentWallet = null;

    // --- Utility Functions ---
    
    /** Converts MIST (BigInt) to SUI (string with decimals) */
    function formatMistToSui(mistAmount, decimals = 9, precision = 4) {
        if (typeof mistAmount === 'string') {
            mistAmount = BigInt(mistAmount);
        }
        
        const divisor = BigInt(10) ** BigInt(decimals);
        const integerPart = mistAmount / divisor;
        const remainder = mistAmount % divisor;
        
        // Pad the remainder with leading zeros and slice to desired precision
        let decimalPart = remainder.toString().padStart(decimals, '0').slice(0, precision);
        
        return `${integerPart.toString()}.${decimalPart}`;
    }

    // --- DOM Elements ---
    const connectBtn = document.getElementById('connectBtn');
    const addressEl = document.getElementById('address');
    const balanceEl = document.getElementById('balance');
    const statusEl = document.getElementById('status');
    const modal = document.getElementById('walletModal');
    const walletList = document.getElementById('walletList');
    const closeModal = document.getElementsByClassName('close')[0];
    const txSection = document.getElementById('txSection');
    const txList = document.getElementById('txList');
    const transferSection = document.getElementById('transferSection');
    const recipientInput = document.getElementById('recipient');
    const amountInput = document.getElementById('amount');
    const sendBtn = document.getElementById('sendBtn');
    const txResult = document.getElementById('txResult');
    const nftSection = document.getElementById('nftSection');
    const nftGrid = document.getElementById('nftGrid');

    // --- UI Update and Data Loading ---

    async function updateUI() {
      if (currentAccount && currentAccount.address) {
        addressEl.textContent = currentAccount.address.slice(0, 6) + '...' + currentAccount.address.slice(-4);
        connectBtn.textContent = 'Disconnect';
        statusEl.textContent = `Connected via ${currentWallet?.name || 'Wallet'}`;
        
        // Show connected sections
        transferSection.style.display = 'block';
        txSection.style.display = 'block';
        nftSection.style.display = 'block';

        // Balance (using improved formatting)
        try {
          const { totalBalance } = await client.getBalance({ owner: currentAccount.address });
          balanceEl.textContent = `${formatMistToSui(totalBalance)} SUI`;
        } catch { 
          balanceEl.textContent = 'Error loading balance';
        }

        // Transactions & NFTs
        await Promise.all([loadTransactions(), loadNFTs()]);
      } else {
        // Hide and reset sections
        addressEl.textContent = '-';
        balanceEl.textContent = '-';
        connectBtn.textContent = 'Connect Wallet';
        statusEl.textContent = '';
        transferSection.style.display = 'none';
        txSection.style.display = 'none';
        nftSection.style.display = 'none';
        txList.innerHTML = '';
        nftGrid.innerHTML = '';
        txResult.innerHTML = '';
      }
    }

    async function loadTransactions() {
      if (!currentAccount?.address) return;
      txList.innerHTML = '<li>Loading recent transactions...</li>';
      try {
        const txns = await client.queryTransactionBlocks({
          filter: { Or: [{ FromAddress: currentAccount.address }, { ToAddress: currentAccount.address }] },
          order: 'descending',
          limit: 10,
          options: { showEffects: true, showBalanceChanges: true }
        });
        
        txList.innerHTML = txns.data.length === 0 ? '<li>No transactions yet.</li>' : '';
        
        txns.data.forEach(txn => {
          const li = document.createElement('li');
          const link = `https://suiscan.xyz/${NETWORK}/tx/${txn.digest}`;
          const status = txn.effects?.status?.status || 'Unknown';
          
          let desc = 'Other Interaction', amount = '';
          const suiChange = txn.balanceChanges?.find(c => c.coinType.endsWith('::sui::SUI') && c.owner.AddressOwner === currentAccount.address);
          
          if (suiChange) {
            const change = formatMistToSui(suiChange.amount, 9, 6);
            desc = BigInt(suiChange.amount) > 0 ? 'Received' : 'Sent';
            amount = BigInt(suiChange.amount) > 0 ? `+${change}` : change;
          }
          
          li.innerHTML = `<strong><a href="${link}" target="_blank">${txn.digest.slice(0, 10)}...</a></strong><br>${desc} ${amount} SUI • <span style="color:${status==='success'?'green':'red'}">${status}</span>`;
          txList.appendChild(li);
        });
      } catch (err) {
        console.error("Error loading transactions:", err);
        txList.innerHTML = '<li>Error loading transactions.</li>';
      }
    }

    async function loadNFTs() {
      if (!currentAccount?.address) return;
      nftGrid.innerHTML = '<div class="nft-card">Loading NFTs...</div>';
      try {
        const objects = await client.getOwnedObjects({
          owner: currentAccount.address,
          options: { showDisplay: true, showType: true },
          limit: 50
        });

        const nfts = objects.data.filter(obj => obj.data?.display?.data);

        nftGrid.innerHTML = nfts.length === 0 ? '<div class="nft-card">No NFTs found (standard-compliant).</div>' : '';

        nfts.forEach(obj => {
          const display = obj.data.display.data;
          const name = display.name || 'Unnamed NFT';
          const description = display.description || '';
          const imageUrl = display.image_url || display.imageUrl || 'https://via.placeholder.com/300?text=No+Image';

          const card = document.createElement('div');
          card.className = 'nft-card';
          card.innerHTML = 
          `
            <img src="${imageUrl}" alt="${name}" onerror="this.src='https://via.placeholder.com/300?text=Image+Not+Found'" />
            <h3>${name}</h3>
            <p>${description.length > 50 ? description.slice(0, 50) + '...' : description}</p>
            <small>Object ID: ${obj.data.objectId.slice(0,10)}...</small>
          `;
          nftGrid.appendChild(card);
        });
      } catch (err) {
        nftGrid.innerHTML = '<div class="nft-card">Error loading NFTs.</div>';
        console.error(err);
      }
    }

    // --- Transaction Logic ---

    async function sendSui() {
      if (!currentAccount || !currentWallet) {
        txResult.innerHTML = '<span style="color:red">Wallet not connected – please reconnect.</span>';
        return;
      }

      const recipient = recipientInput.value.trim();
      const amountStr = amountInput.value.trim();
      const amount = parseFloat(amountStr);
      
      // Basic Input Validation
      if (!recipient || !amountStr) {
        txResult.innerHTML = '<span style="color:red">Please fill both recipient and amount fields.</span>';
        return;
      }
      if (amount <= 0 || isNaN(amount)) {
        txResult.innerHTML = '<span style="color:red">Invalid amount. Must be a positive number.</span>';
        return;
      }
      
      txResult.textContent = 'Preparing and requesting signature...';
      sendBtn.disabled = true;

      try {
        // Convert SUI amount to MIST BigInt
        // Note: Using BigInt * Number and Math.round to handle large numbers and decimals correctly for the conversion.
        const amountMist = BigInt(Math.round(amount * Number(MIST_PER_SUI)));

        const txb = new Transaction();
        
        // 1. Split the gas coin to create a new coin object with the transfer amount.
        const [coin] = txb.splitCoins(txb.gas, [amountMist]);
        
        // 2. Transfer the newly split coin object to the recipient.
        txb.transferObjects([coin], recipient);

        const serializedTx = await txb.serialize();
        
        // 3. Request wallet signature and execution
        const result = await currentWallet.features['sui:signAndExecuteTransaction'].signAndExecuteTransaction({
          transaction: serializedTx,
          chain: `sui:${NETWORK}`
        });

        // 4. Handle result
        if (result.effects?.status?.status === 'success') {
          const link = `https://suiscan.xyz/${NETWORK}/tx/${result.digest}`;
          txResult.innerHTML = `<span style="color:green">Success! <a href="${link}" target="_blank">View on Suiscan</a></span>`;
          recipientInput.value = ''; 
          amountInput.value = '';
          updateUI(); // Refresh balance and transaction list
        } else {
          // Transaction failed on-chain
          txResult.innerHTML = `<span style="color:red">Transaction Failed: ${result.effects?.status?.error || 'Unknown Error'}</span>`;
        }
      } catch (err) {
        // Wallet rejection or serialization/network error
        console.error("Transaction Error:", err);
        let errorMsg = err.message || 'Transaction Rejected by Wallet or Network Error';
        if (errorMsg.includes('Insufficient gas')) {
             errorMsg = 'Insufficient SUI balance or Gas budget too low.';
        }
        txResult.innerHTML = `<span style="color:red">Error: ${errorMsg}</span>`;
      } finally {
        sendBtn.disabled = false;
      }
    }

    // --- Wallet Connection Functions (Unchanged as they were clean) ---
    async function connectWallet(wallet) {
      try {
        const { accounts } = await wallet.features['standard:connect'].connect();
        if (accounts.length > 0) {
          currentAccount = accounts[0];
          currentWallet = wallet;
        }
      } catch {
        statusEl.textContent = 'Connection rejected';
      }
      modal.style.display = 'none';
      updateUI();
    }

    async function disconnect() {
      if (currentWallet?.features['standard:disconnect']) {
        await currentWallet.features['standard:disconnect'].disconnect();
      }
      currentAccount = null;
      currentWallet = null;
      updateUI();
    }

    function showModal() {
      const available = wallets.get();
      walletList.innerHTML = available.length === 0 ? '<li>No wallet detected. Install one and refresh.</li>' : '';
      available.forEach(wallet => {
        const li = document.createElement('li');
        const btn = document.createElement('button');
        btn.textContent = `${wallet.name} ${wallet.accounts.length > 0 ? '(Connected)' : ''}`;
        btn.onclick = () => connectWallet(wallet);
        li.appendChild(btn);
        walletList.appendChild(li);
      });
      modal.style.display = 'block';
    }

    // --- Event Listeners ---
    connectBtn.onclick = () => currentAccount ? disconnect() : showModal();
    closeModal.onclick = () => modal.style.display = 'none';
    window.onclick = e => { if (e.target === modal) modal.style.display = 'none'; };
    sendBtn.onclick = sendSui;

    // Listen for wallet changes (e.g., account switch in wallet extension)
    wallets.on('change', () => {
      const all = wallets.get();
      let found = false;
      all.forEach(w => {
        if (w.accounts.length > 0) {
          currentAccount = w.accounts[0];
          currentWallet = w;
          found = true;
        }
      });
      
      if (!found) { currentAccount = null; currentWallet = null; }
      updateUI();
    });

    // Initial check on load
    setTimeout(() => {
      wallets.get().forEach(w => {
        if (w.accounts.length > 0) {
          currentAccount = w.accounts[0];
          currentWallet = w;
        }
      });
      updateUI();
    }, 1000);

  </script>

  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 30px; background: #f0f8ff; max-width: 900px; margin: auto; }
    h1 { color: #0066ff; }
    button { padding: 12px 24px; background: #0066ff; color: white; border: none; border-radius: 8px; cursor: pointer; margin: 10px; }
    button:hover { background: #0055cc; }
    button:disabled { background: #aaa; }
    input { padding: 12px; width: 320px; margin: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 16px; }
    .section { margin: 40px 0; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    #txList { list-style: none; padding: 0; text-align: left; }
    #txList li { padding: 15px; margin: 8px 0; background: #f8f9fa; border-radius: 8px; }
    #nftGrid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; padding: 20px 0; }
    .nft-card { background: #fff; border-radius: 12px; padding: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); text-align: center; }
    .nft-card img { width: 100%; height: auto; border-radius: 8px; max-height: 300px; object-fit: contain; background: #eee; }
    .nft-card h3 { margin: 10px 0 5px; font-size: 18px; }
    .nft-card p { color: #666; font-size: 14px; }
    #status { margin: 20px; font-weight: bold; min-height: 24px; }
    #txResult { margin-top: 15px; font-size: 18px; }
    .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
    .modal-content { background: white; margin: 15% auto; padding: 20px; width: 80%; max-width: 500px; border-radius: 12px; }
    .close { color: #aaa; float: right; font-size: 28px; cursor: pointer; }
    #walletList button { width: 100%; margin: 8px 0; padding: 12px; }
  </style>
</head>
<body>
  <h1>Sui Wallet Dashboard + NFTs</h1>
  <p>Connect your wallet to view balance, transactions, send SUI, and see your NFTs!</p>

  <button id="connectBtn">Connect Wallet</button>

  <div class="section">
    <p><strong>Address:</strong> <span id="address">-</span></p>
    <p><strong>SUI Balance (${NETWORK}):</strong> <span id="balance">-</span></p>
  </div>

  <p id="status">Detecting wallet...</p>

  <div id="transferSection" class="section" style="display:none;">
    <h2>Send SUI</h2>
    <input type="text" id="recipient" placeholder="Recipient address (0x...)" /><br>
    <input type="number" id="amount" step="0.0001" placeholder="Amount in SUI" /><br>
    <button id="sendBtn">Send SUI</button>
    <div id="txResult"></div>
  </div>

  <div id="txSection" class="section" style="display:none;">
    <h2>Recent Transactions</h2>
    <ul id="txList"></ul>
  </div>

  <div id="nftSection" class="section" style="display:none;">
    <h2>Your NFTs</h2>
    <div id="nftGrid"></div>
    <p><small>Only standard-compliant NFTs (with Display metadata) are shown. Some airdropped/scam NFTs may not appear.</small></p>
  </div>

  <div id="walletModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Select Wallet</h2>
      <ul id="walletList"></ul>
    </div>
  </div>
</body>
</html>
