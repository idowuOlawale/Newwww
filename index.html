<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus Pay - LASUSTECH</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; text-align: center; }
        input { margin: 10px; padding: 5px; width: 80%; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }
        button:disabled { background: gray; }
        button:hover { background: #0056b3; }
        #status { color: green; font-weight: bold; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>Campus Pay</h1>
    <p>A simple payment system for LASUSTECH campus using Sui blockchain. Connect your wallet and transfer SUI for payments.</p>
    
    <button id="connectButton">Connect Sui Wallet</button>
    <p id="address"></p>
    
    <div id="paymentForm" style="display: none;">
        <label for="recipient">Recipient Wallet Address:</label><br>
        <input id="recipient" type="text" placeholder="0x..."><br>
        
        <label for="amount">Amount (SUI):</label><br>
        <input id="amount" type="number" step="0.001" min="0.001" placeholder="0.1"><br>
        
        <button id="payButton">Make Payment</button>
    </div>
    
    <p id="status"></p>
    
    <script type="module">
        import { getFullnodeUrl } from 'https://unpkg.com/@mysten/sui@latest/client?module';
        import { SuiClient } from 'https://unpkg.com/@mysten/sui@latest/client?module';
        import { Transaction } from 'https://unpkg.com/@mysten/sui@latest/transactions?module';
        import { getWallets } from 'https://unpkg.com/@wallet-standard/app@latest?module';

        const { get, on } = getWallets();
        let wallets = get().filter(wallet => wallet.chains.some(chain => chain.startsWith('sui:'))); // Filter for Sui wallets
        on('register', () => {
            wallets = get().filter(wallet => wallet.chains.some(chain => chain.startsWith('sui:')));
        });

        let currentWallet;
        let currentAccount;

        const client = new SuiClient({ url: getFullnodeUrl('testnet') });

        const connectButton = document.getElementById('connectButton');
        connectButton.onclick = async () => {
            if (wallets.length === 0) {
                alert('No Sui wallet detected. Install a Sui wallet extension like Sui Wallet.');
                return;
            }
            currentWallet = wallets[0]; // Use the first Sui wallet for simplicity
            try {
                const result = await currentWallet.features['standard:connect'].connect();
                currentAccount = result.accounts[0];
                document.getElementById('address').innerText = `Connected: ${currentAccount.address}`;
                document.getElementById('paymentForm').style.display = 'block';
                connectButton.disabled = true;
            } catch (e) {
                alert(`Connection failed: ${e.message}`);
            }
        };

        const payButton = document.getElementById('payButton');
        payButton.onclick = async () => {
            const recipient = document.getElementById('recipient').value;
            const amount = parseFloat(document.getElementById('amount').value);

            if (!recipient || isNaN(amount) || amount <= 0) {
                document.getElementById('status').innerText = 'Please enter a valid recipient and amount.';
                document.getElementById('status').classList.add('error');
                return;
            }

            const status = document.getElementById('status');
            status.innerText = 'Processing...';
            status.classList.remove('error');

            try {
                const tx = new Transaction();
                const amountMist = Math.floor(amount * 1_000_000_000); // Convert SUI to MIST (10^9)
                const [coin] = tx.splitCoins(tx.gas, [amountMist]);
                tx.transferObjects([coin], recipient);

                const { transactionBlockBytes } = await tx.build({ client });

                const signResult = await currentWallet.features['sui:signTransactionBlock'].signTransactionBlock({
                    transactionBlock: transactionBlockBytes,
                    chain: currentAccount.chains[0], // e.g., 'sui:testnet'
                });

                const executeResult = await client.executeTransactionBlock({
                    transactionBlock: transactionBlockBytes,
                    signature: signResult.signature,
                    options: { showEffects: true }
                });

                status.innerText = `Payment successful! Tx Digest: ${executeResult.digest}`;
            } catch (e) {
                status.innerText = `Error: ${e.message}`;
                status.classList.add('error');
            }
        };
    </script>
</body>
</html>
